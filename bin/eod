#!/usr/bin/env python
#
# Aid in sending an EOD message. Pretty specific to my setup.
# This will take my markdown notes convert to html, open an email with the contents and archive the notes
# replacing them with the empty template. I then just review the email and hit send.
#
# I am using blackfriday-tool for md processing but that could be easily replaced, specifically I
# could consider the python-markdown package but after trying that it doesn't handle my common nested
# lists as well.
#
# TODO
#  - The rendering includes bunches of extra blank lines when looking in Thunderbird. This is only a thunderbird problem
#    with or without css both firefox and chrome render it fine.
#    - I could just send the email directly with smtp, but there are a number of things I don't like about that, no preview, another app with credentials,
#      and I would have to connect to imap also to save in a sent folder.
#    - A possibly related bug https://bugs.launchpad.net/ubuntu/+source/thunderbird/+bug/1021813
#  - Figure out how to include the summary url info into the email also.

from datetime import datetime
import os
import shutil
import subprocess
import sys
import tempfile

EMAIL = "IS - Foxtrot Squad <foxtrot-reports@greenteam.canonical.com>"
ARCHIVE_DIR = "/home/tim/data/EOD-reports"
TEMPLATE = "/home/tim/data/EOD-reports/daily.md.template"
NOTES_FILE = "/home/tim/daily.md"
SUBJECT_TEMPLATE = "%Y-%m-%d (%a) EOD Report for Tim Kuhlman"
SUMMARY_URL = "https://portal.admin.canonical.com/myday"

def main(argv=None):
    if argv is None:
        argv = sys.argv

    # Archive the current daily report
    now = datetime.now()
    adir = os.path.join(ARCHIVE_DIR, now.strftime("%Y"))
    if not os.path.exists(adir):
      os.mkdir(adir)
    shutil.copyfile(NOTES_FILE, os.path.join(adir, now.strftime("%Y-%m-%d") + '.md'))

    # Create html from the daily report
    html_header = "<html>\n<head>\n<style>\nbr{display: none}\np{margin:0}\nli{margin:0; padding:0}\nh3{margin:0; padding:0}\nh4{margin:0; padding:0}\n</style>\n</head><body>\n"
    html_footer = "</body></html>"
    tdir = tempfile.mkdtemp()
    tpath = os.path.join(tdir, 'daily.html')
    subprocess.check_call(['blackfriday-tool', NOTES_FILE, tpath])
    with open(tpath, 'r') as tfile:
        html_body = tfile.read()
    os.remove(tpath)
    os.rmdir(tdir)
    email_body = html_header + html_body + html_footer

    # Copy the template over the daily.md
    shutil.copyfile(TEMPLATE, NOTES_FILE)

    # Open up the summary url
    subprocess.check_call(['xdg-open', SUMMARY_URL])

    # Start up an email in thunderbird - http://kb.mozillazine.org/Command_line_arguments_(Thunderbird)
    contents = "to='{}',subject='{}',format=1,body='{}'".format(EMAIL,
                                                                now.strftime(SUBJECT_TEMPLATE),
                                                                email_body)
    subprocess.check_call(['thunderbird', '-compose', contents])


if __name__ == "__main__":
    sys.exit(main())
