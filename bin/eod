#!/usr/bin/env python
#
# Aid in sending an EOD message. Pretty specific to my setup.
# This will take my markdown notes, open an email with the contents and archive the notes
# replacing them with the empty template. I then just review the email and hit send.
# I originally was rendering my markdown to html but Thunderbirds html rendering sucks so I am
# just sending the raw markdown instead.
#
# TODO
#  - If the email body has quotes ' in it, it will be truncated.
#  - Figure out how to include the summary url info into the email also.

from datetime import datetime
import os
import shutil
import subprocess
import sys
import tempfile

EMAIL = "IS - Whiskey Squad <whiskey-reports@greenteam.canonical.com>"
ARCHIVE_DIR = "/home/tim/data/EOD-reports"
TEMPLATE = "/home/tim/data/EOD-reports/daily.md.template"
NOTES_FILE = "/home/tim/daily.md"
SUBJECT_TEMPLATE = "%Y-%m-%d (%a) EOD Report for Tim Kuhlman"
SUMMARY_URL = "https://portal.admin.canonical.com/myday"

def main(argv=None):
    if argv is None:
        argv = sys.argv

    # Archive the current daily report
    now = datetime.now()
    adir = os.path.join(ARCHIVE_DIR, now.strftime("%Y"))
    if not os.path.exists(adir):
      os.mkdir(adir)
    shutil.copyfile(NOTES_FILE, os.path.join(adir, now.strftime("%Y-%m-%d") + '.md'))

    # Read the dail report contents then copy the template over the daily.md
    with open(NOTES_FILE, 'r') as daily:
        email_body = daily.read()
    shutil.copyfile(TEMPLATE, NOTES_FILE)

    # Open up the summary url
    subprocess.check_call(['xdg-open', SUMMARY_URL])

    # Start up an email in thunderbird - http://kb.mozillazine.org/Command_line_arguments_(Thunderbird)
    contents = "to='{}',subject='{}',format=2,body='{}'".format(EMAIL,
                                                                now.strftime(SUBJECT_TEMPLATE),
                                                                email_body)
    subprocess.check_call(['thunderbird', '-compose', contents])


if __name__ == "__main__":
    sys.exit(main())
